import { Clock, Shield } from 'lucide-react';

function VulnerabilityFeed({ scans, loading, limit = 20 }) {
    if (loading) {
        return (
            <div className="card">
                <div className="card-header">
                    <span className="card-title">Recent Scans</span>
                </div>
                <div className="loading-overlay">
                    <div className="spinner" />
                    Loading scan history...
                </div>
            </div>
        );
    }

    const displayScans = (scans || []).slice(0, limit);

    if (displayScans.length === 0) {
        return (
            <div className="card">
                <div className="card-header">
                    <span className="card-title">Recent Scans</span>
                </div>
                <div className="empty-state">
                    <div className="empty-icon">üîç</div>
                    <h3>No scans yet</h3>
                    <p>Use the scanner to analyze your first contract</p>
                </div>
            </div>
        );
    }

    const getSeverityClass = (level) => (level || 'unknown').toLowerCase();

    const formatTime = (ts) => {
        if (!ts) return '';
        const d = new Date(ts);
        const now = new Date();
        const diff = Math.floor((now - d) / 1000);

        if (diff < 60) return 'just now';
        if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
        return d.toLocaleDateString();
    };

    const truncateAddr = (addr) => {
        if (!addr) return '';
        return `${addr.slice(0, 6)}...${addr.slice(-4)}`;
    };

    return (
        <div className="card">
            <div className="card-header">
                <span className="card-title">Recent Scans</span>
                <span style={{ fontSize: '12px', color: 'var(--text-muted)' }}>
                    {displayScans.length} results
                </span>
            </div>
            <div className="vuln-feed">
                {displayScans.map((scan, i) => {
                    const riskLevel = scan.riskLevel || scan.risk_level || 'UNKNOWN';
                    const contract = scan.contractAddress || scan.contract_address || '';
                    const name = scan.contractName || scan.contract_name || 'Unknown';
                    const score = scan.overallScore || scan.overall_score || 0;
                    const timestamp = scan.timestamp || scan.created_at;
                    const critical = scan.counts?.critical || scan.critical_count || 0;
                    const high = scan.counts?.high || scan.high_count || 0;
                    const medium = scan.counts?.medium || scan.medium_count || 0;
                    const low = scan.counts?.low || scan.low_count || 0;

                    return (
                        <div className="vuln-item" key={scan.id || i}>
                            <span className={`severity-badge ${getSeverityClass(riskLevel)}`}>
                                {riskLevel}
                            </span>
                            <div className="vuln-meta">
                                <div className="vuln-title">{name}</div>
                                <div className="vuln-contract">{truncateAddr(contract)}</div>
                                <div style={{ marginTop: '6px', display: 'flex', gap: '12px', fontSize: '12px', color: 'var(--text-muted)' }}>
                                    {critical > 0 && <span style={{ color: 'var(--critical)' }}>üî¥ {critical} critical</span>}
                                    {high > 0 && <span style={{ color: 'var(--high)' }}>üü† {high} high</span>}
                                    {medium > 0 && <span style={{ color: 'var(--medium)' }}>üü° {medium} medium</span>}
                                    {low > 0 && <span style={{ color: 'var(--low)' }}>üü¢ {low} low</span>}
                                    <span>Score: {score}/100</span>
                                </div>
                            </div>
                            <div className="vuln-time">
                                <Clock size={12} style={{ marginRight: '4px', verticalAlign: 'middle' }} />
                                {formatTime(timestamp)}
                            </div>
                        </div>
                    );
                })}
            </div>
        </div>
    );
}

export default VulnerabilityFeed;
